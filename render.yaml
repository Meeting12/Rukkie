services:
  - type: web
    name: rukkie-web
    env: python
    plan: starter
    healthCheckPath: /api/auth/status/
    buildCommand: |
      pip install -r requirements.txt &&
      npm install --prefix frontend &&
      npm run build:django --prefix frontend &&
      python manage.py collectstatic --noinput
    preDeployCommand: python manage.py migrate --noinput
    startCommand: gunicorn Rukkie.wsgi:application --workers 3 --timeout 120
    envVars:
      - key: DJANGO_SETTINGS_MODULE
        value: Rukkie.settings
      - key: SECRET_KEY
        sync: false
      - key: DATABASE_URL
        fromDatabase:
          name: rukkie-db
          property: connectionString
      - key: DEBUG
        value: "False"
      - key: LOG_LEVEL
        value: "INFO"
      - key: STORE_METADATA_ASYNC
        value: "True"
      - key: STORE_USE_EXTERNAL_VISION
        value: "False"
      - key: ALLOWED_HOSTS
        value: ".onrender.com"
      - key: CSRF_TRUSTED_ORIGINS
        value: "https://*.onrender.com"
      - key: CORS_ALLOWED_ORIGINS
        sync: false
      - key: REQUEST_BODY_MAX_BYTES
        value: "2097152"
      - key: RATE_LIMIT_CHAT_LIMIT
        value: "45"
      - key: RATE_LIMIT_CHAT_WINDOW_SECONDS
        value: "60"
      - key: RATE_LIMIT_CONTACT_LIMIT
        value: "8"
      - key: RATE_LIMIT_CONTACT_WINDOW_SECONDS
        value: "300"
      - key: RATE_LIMIT_NEWSLETTER_LIMIT
        value: "10"
      - key: RATE_LIMIT_NEWSLETTER_WINDOW_SECONDS
        value: "300"
      - key: RATE_LIMIT_AUTH_REGISTER_LIMIT
        value: "8"
      - key: RATE_LIMIT_AUTH_REGISTER_WINDOW_SECONDS
        value: "600"
      - key: RATE_LIMIT_AUTH_LOGIN_LIMIT
        value: "12"
      - key: RATE_LIMIT_AUTH_LOGIN_WINDOW_SECONDS
        value: "300"
      - key: RATE_LIMIT_PAYPAL_CREATE_ORDER_LIMIT
        value: "40"
      - key: RATE_LIMIT_PAYPAL_CREATE_ORDER_WINDOW_SECONDS
        value: "60"
      - key: RATE_LIMIT_PAYPAL_CAPTURE_ORDER_LIMIT
        value: "40"
      - key: RATE_LIMIT_PAYPAL_CAPTURE_ORDER_WINDOW_SECONDS
        value: "60"
      - key: RATE_LIMIT_PAYPAL_WEBHOOK_LIMIT
        value: "180"
      - key: RATE_LIMIT_PAYPAL_WEBHOOK_WINDOW_SECONDS
        value: "60"
      - key: CELERY_BROKER_URL
        fromService:
          type: redis
          name: rukkie-redis
          property: connectionString
      - key: CELERY_RESULT_BACKEND
        fromService:
          type: redis
          name: rukkie-redis
          property: connectionString
      - key: STRIPE_MODE
        value: "LIVE"
      - key: STRIPE_SECRET_KEY
        sync: false
      - key: STRIPE_PUBLISHABLE_KEY
        sync: false
      - key: FLUTTERWAVE_MODE
        value: "LIVE"
      - key: FLUTTERWAVE_SECRET_KEY
        sync: false
      - key: PAYPAL_ENV
        value: "live"
      - key: PAYPAL_CLIENT_ID
        sync: false
      - key: PAYPAL_CLIENT_SECRET
        sync: false
      - key: STRIPE_WEBHOOK_SECRET
        sync: false
      - key: FLUTTERWAVE_WEBHOOK_SECRET
        sync: false
      - key: PAYPAL_WEBHOOK_ID
        sync: false
      - key: PAYMENT_VERIFY_TOKEN
        sync: false
  - type: worker
    name: rukkie-worker
    env: python
    plan: starter
    buildCommand: |
      pip install -r requirements.txt
    startCommand: celery -A Rukkie worker --loglevel=info
    envVars:
      - key: DJANGO_SETTINGS_MODULE
        value: Rukkie.settings
      - key: SECRET_KEY
        sync: false
      - key: DATABASE_URL
        fromDatabase:
          name: rukkie-db
          property: connectionString
      - key: DEBUG
        value: "False"
      - key: LOG_LEVEL
        value: "INFO"
      - key: STORE_METADATA_ASYNC
        value: "True"
      - key: STORE_USE_EXTERNAL_VISION
        value: "False"
      - key: RATE_LIMIT_CHAT_LIMIT
        value: "45"
      - key: RATE_LIMIT_CHAT_WINDOW_SECONDS
        value: "60"
      - key: RATE_LIMIT_CONTACT_LIMIT
        value: "8"
      - key: RATE_LIMIT_CONTACT_WINDOW_SECONDS
        value: "300"
      - key: RATE_LIMIT_NEWSLETTER_LIMIT
        value: "10"
      - key: RATE_LIMIT_NEWSLETTER_WINDOW_SECONDS
        value: "300"
      - key: RATE_LIMIT_AUTH_REGISTER_LIMIT
        value: "8"
      - key: RATE_LIMIT_AUTH_REGISTER_WINDOW_SECONDS
        value: "600"
      - key: RATE_LIMIT_AUTH_LOGIN_LIMIT
        value: "12"
      - key: RATE_LIMIT_AUTH_LOGIN_WINDOW_SECONDS
        value: "300"
      - key: RATE_LIMIT_PAYPAL_CREATE_ORDER_LIMIT
        value: "40"
      - key: RATE_LIMIT_PAYPAL_CREATE_ORDER_WINDOW_SECONDS
        value: "60"
      - key: RATE_LIMIT_PAYPAL_CAPTURE_ORDER_LIMIT
        value: "40"
      - key: RATE_LIMIT_PAYPAL_CAPTURE_ORDER_WINDOW_SECONDS
        value: "60"
      - key: RATE_LIMIT_PAYPAL_WEBHOOK_LIMIT
        value: "180"
      - key: RATE_LIMIT_PAYPAL_WEBHOOK_WINDOW_SECONDS
        value: "60"
      - key: CELERY_BROKER_URL
        fromService:
          type: redis
          name: rukkie-redis
          property: connectionString
      - key: CELERY_RESULT_BACKEND
        fromService:
          type: redis
          name: rukkie-redis
          property: connectionString
      - key: STRIPE_MODE
        value: "LIVE"
      - key: STRIPE_SECRET_KEY
        sync: false
      - key: FLUTTERWAVE_MODE
        value: "LIVE"
      - key: FLUTTERWAVE_SECRET_KEY
        sync: false
      - key: PAYPAL_ENV
        value: "live"
      - key: PAYPAL_CLIENT_ID
        sync: false
      - key: PAYPAL_CLIENT_SECRET
        sync: false
      - key: STRIPE_WEBHOOK_SECRET
        sync: false
      - key: FLUTTERWAVE_WEBHOOK_SECRET
        sync: false
      - key: PAYPAL_WEBHOOK_ID
        sync: false
      - key: PAYMENT_VERIFY_TOKEN
        sync: false

databases:
  - name: rukkie-db
    plan: starter

addons:
  - type: redis
    name: rukkie-redis
    plan: starter
